<!DOCTYPE html>
<html lang="en">
<head>
	<title>Gemeinde Online | Sign-up</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="description" content="">
	<link href="../../../resources/libs/bootstrap/bootstrap.css" rel="stylesheet">
	<link href="../../../resources/assets/css/style.css" rel="stylesheet">
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/js/bootstrap.bundle.min.js" integrity="sha384-b5kHyXgcpbZJO/tY9Ul7kGkf1S0CWuKcCD38l8YkeH8z8QjE0GmW1gYU5S9FOnJ0" crossorigin="anonymous"></script>

	<script src="https://unpkg.com/vue@next"></script>
	<script src="https://unpkg.com/axios/dist/axios.min.js"></script>

</head>
<body>
<style>

	#location_name::first-letter {
		text-transform: uppercase;
		color: red;
	}
	#modalLabel_location{
		margin-right: 5px;
	}
</style>

<div class="container">
	<div id="email-container">
		<form @submit="submit" method="post" class="needs-validation" novalidate>
			<div class="mb-3">
				<label for="email" class="form-label">E-mail address</label>
				<input type="email" class="form-control" name="email" id="email" aria-describedby="emailHelp" v-model="cred.email" required>
				<div class="invalid-feedback">
					<p v-if="errors.length">
					<ul>
						<li v-for="error in errors">{{ error }}</li>
					</ul>
					</p>
				</div>
			</div>
			<button type="submit"  class="btn btn-primary">Submit</button>
		</form>
	</div>
</div>

<script>

	var code = {
		names: 'location', data() {
			return {
				errors: [],
				path: 'http://localhost:8080',
				token: null,
				googleSiteKey: null,
				cred: {
					email: null,
				},
			}
		},
		methods: {

			submit(e) {
				var regex = new RegExp('(?:[a-z0-9!#$%&\'*+/=?^_`{|}~-]+(?:\\.[a-z0-9!#$%&\'*+/=?^_`{|}~-]+)*|"(?:[\x01-\x08\x0b\x0c\x0e-\x1f\x21\x23-\x5b\x5d-\x7f]|\\\\[\x01-\x09\x0b\x0c\x0e-\x7f])*")@(?:(?:[a-z0-9](?:[a-z0-9-]*[a-z0-9])?\\.)+[a-z0-9](?:[a-z0-9-]*[a-z0-9])?|\\[(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?|[a-z0-9-]*[a-z0-9]:(?:[\x01-\x08\x0b\x0c\x0e-\x1f\x21-\x5a\x53-\x7f]|\\\\[\x01-\x09\x0b\x0c\x0e-\x7f])+)\\])');
				if((regex.test(this.cred.email)) == false){
					this.errors.push('email is bad')
					document.getElementById("email").classList.add("is-invalid")
				}else{
					document.getElementById("email").classList.remove("is-invalid")
				}

				e.preventDefault();

				const email = this.cred.email
				const path = this.path
				const key = this.googleSiteKey
						grecaptcha.execute(key, {action: 'submit'}).then(function(token) {
						axios.post(path+"/api/auth/email",{email: email, token: token})
							.catch((err) => {
								console.warn(err.response.data)
							});
					});

			},
			async getKeys(){
				await axios.post(this.path+"/api/keys").then(responce => (
					this.googleSiteKey = responce.data.googleRecaptchaSiteKey
				));
				var script = document.createElement('script');
				script.src = "https://www.google.com/recaptcha/api.js?render="+this.googleSiteKey;
				document.getElementsByTagName('head')[0].appendChild(script);//TODO use set Attribute
			}

		},
		mounted: async function(){
			await this.getKeys();
		},
	}


	var app = Vue.createApp(code)

	app.mount('#email-container')

</script>


</body>
